"use strict";(self.webpackChunkaxux=self.webpackChunkaxux||[]).push([[4215],{"./node_modules/@arcgis/core/layers/graphics/data/QueryEngine.js":(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{q:()=>ee});var _core_arrayUtils_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@arcgis/core/core/arrayUtils.js"),_core_Error_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@arcgis/core/core/Error.js"),_core_lang_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@arcgis/core/core/lang.js"),_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__=__webpack_require__("./node_modules/@arcgis/core/core/maybe.js"),_core_MemCache_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/@arcgis/core/core/MemCache.js"),_core_promiseUtils_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./node_modules/@arcgis/core/core/promiseUtils.js"),_core_unitUtils_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./node_modules/@arcgis/core/core/unitUtils.js"),_geometry_support_aaBoundingBox_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./node_modules/@arcgis/core/geometry/support/aaBoundingBox.js"),_geometry_support_aaBoundingRect_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./node_modules/@arcgis/core/geometry/support/aaBoundingRect.js"),_geometry_support_boundsUtils_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./node_modules/@arcgis/core/geometry/support/boundsUtils.js"),_geometry_support_jsonUtils_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__("./node_modules/@arcgis/core/geometry/support/jsonUtils.js"),_geometry_support_normalizeUtils_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__("./node_modules/@arcgis/core/geometry/support/normalizeUtils.js"),_geometry_support_spatialReferenceUtils_js__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__("./node_modules/@arcgis/core/geometry/support/spatialReferenceUtils.js"),_featureConversionUtils_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/featureConversionUtils.js"),_attributeSupport_js__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/data/attributeSupport.js"),_projectionSupport_js__WEBPACK_IMPORTED_MODULE_14__=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/data/projectionSupport.js"),_QueryEngineCapabilities_js__WEBPACK_IMPORTED_MODULE_15__=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/data/QueryEngineCapabilities.js"),_QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/data/QueryEngineResult.js"),_spatialQuerySupport_js__WEBPACK_IMPORTED_MODULE_17__=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/data/spatialQuerySupport.js"),_timeSupport_js__WEBPACK_IMPORTED_MODULE_23__=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/data/timeSupport.js"),_utils_js__WEBPACK_IMPORTED_MODULE_18__=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/data/utils.js"),_support_FieldsIndex_js__WEBPACK_IMPORTED_MODULE_19__=__webpack_require__("./node_modules/@arcgis/core/layers/support/FieldsIndex.js"),_support_arcadeOnDemand_js__WEBPACK_IMPORTED_MODULE_20__=__webpack_require__("./node_modules/@arcgis/core/support/arcadeOnDemand.js"),_views_support_Scheduler_js__WEBPACK_IMPORTED_MODULE_21__=__webpack_require__("./node_modules/@arcgis/core/views/support/Scheduler.js");const $="feature-store:unsupported-query";const X=new _core_MemCache_js__WEBPACK_IMPORTED_MODULE_3__.WJ(2e6);let Y=0;class ee{constructor(e){this._geometryQueryCache=null,this._changeHandle=null,this.capabilities={query:_QueryEngineCapabilities_js__WEBPACK_IMPORTED_MODULE_15__.g},this.geometryType=e.geometryType,this.hasM=!!e.hasM,this.hasZ=!!e.hasZ,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this.definitionExpression=e.definitionExpression,this.featureStore=e.featureStore,this.aggregateAdapter=e.aggregateAdapter,this._changeHandle=this.featureStore.events.on("changed",(()=>this.clearCache())),this.timeInfo=e.timeInfo,e.cacheSpatialQueries&&(this._geometryQueryCache=new _core_MemCache_js__WEBPACK_IMPORTED_MODULE_3__.Xq(Y+++"$$",X)),this.fieldsIndex=new _support_FieldsIndex_js__WEBPACK_IMPORTED_MODULE_19__.Z(e.fields),e.scheduler&&e.priority&&(this._frameTask=e.scheduler.registerTask(e.priority))}destroy(){this._frameTask=(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.hw)(this._frameTask),this.clearCache(),(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.SC)(this._geometryQueryCache),this._changeHandle=(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.hw)(this._changeHandle),(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.SC)(this.fieldsIndex)}get featureAdapter(){return this.featureStore.featureAdapter}clearCache(){this._geometryQueryCache?.clear(),this._allFeaturesPromise=null,this._timeExtentPromise=null}async executeQuery(e,t){try{return(await this._executeQuery(e,{},t)).createQueryResponse()}catch(i){if(i!==_utils_js__WEBPACK_IMPORTED_MODULE_18__.vF)throw i;return new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y([],e,this).createQueryResponse()}}async executeQueryForCount(e={},t){try{return(await this._executeQuery(e,{returnGeometry:!1,returnCentroid:!1,outSR:null},t)).createQueryResponseForCount()}catch(i){if(i!==_utils_js__WEBPACK_IMPORTED_MODULE_18__.vF)throw i;return 0}}async executeQueryForExtent(e,t){const i=e.outSR;try{const s=await this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},t),r=s.size;return r?{count:r,extent:await this._getBounds(s.items,s.spatialReference,i||this.spatialReference)}:{count:0,extent:null}}catch(s){if(s===_utils_js__WEBPACK_IMPORTED_MODULE_18__.vF)return{count:0,extent:null};throw s}}async executeQueryForIds(e,t){return this.executeQueryForIdSet(e,t).then((e=>Array.from(e)))}async executeQueryForIdSet(e,t){try{const i=await this._executeQuery(e,{returnGeometry:!0,returnCentroid:!1,outSR:null},t),s=i.items,r=new Set;return await this._reschedule((()=>{for(const e of s)r.add(i.featureAdapter.getObjectId(e))}),t),r}catch(i){if(i===_utils_js__WEBPACK_IMPORTED_MODULE_18__.vF)return new Set;throw i}}async executeQueryForSnapping(e,t){const{point:i,distance:s,types:r}=e;if(r===_QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.r.NONE)return{candidates:[]};const a=await this._reschedule((()=>this._checkQuerySupport(e.query)),t),o=!(0,_geometry_support_spatialReferenceUtils_js__WEBPACK_IMPORTED_MODULE_11__.fS)(i.spatialReference,this.spatialReference);o&&await(0,_projectionSupport_js__WEBPACK_IMPORTED_MODULE_14__._W)(i.spatialReference,this.spatialReference);const u="number"==typeof s?s:s.x,c="number"==typeof s?s:s.y,l={xmin:i.x-u,xmax:i.x+u,ymin:i.y-c,ymax:i.y+c,spatialReference:i.spatialReference},h=o?(0,_projectionSupport_js__WEBPACK_IMPORTED_MODULE_14__.iV)(l,this.spatialReference):l;if(!h)return{candidates:[]};const m=(await(0,_geometry_support_normalizeUtils_js__WEBPACK_IMPORTED_MODULE_10__.aX)((0,_geometry_support_jsonUtils_js__WEBPACK_IMPORTED_MODULE_9__.im)(i),null,{signal:t}))[0],p=(await(0,_geometry_support_normalizeUtils_js__WEBPACK_IMPORTED_MODULE_10__.aX)((0,_geometry_support_jsonUtils_js__WEBPACK_IMPORTED_MODULE_9__.im)(h),null,{signal:t}))[0];if((0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.Wi)(m)||(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.Wi)(p))return{candidates:[]};const f=new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y(await this._reschedule((()=>this._searchFeatures(this._getQueryBBoxes(p.toJSON()))),t),a,this);await this._reschedule((()=>this._executeObjectIdsQuery(f)),t),await this._reschedule((()=>this._executeTimeQuery(f)),t),await this._reschedule((()=>this._executeAttributesQuery(f)),t);const d=m.toJSON(),y=o?(0,_projectionSupport_js__WEBPACK_IMPORTED_MODULE_14__.iV)(d,this.spatialReference):d,g=o?Math.max(h.xmax-h.xmin,h.ymax-h.ymin)/2:s;return f.createSnappingResponse({...e,point:y,distance:g},i.spatialReference)}async executeQueryForLatestObservations(e,t){if(!this.timeInfo||!this.timeInfo.trackIdField)throw new _core_Error_js__WEBPACK_IMPORTED_MODULE_1__.Z($,"Missing timeInfo or timeInfo.trackIdField",{query:e,timeInfo:this.timeInfo});try{const i=await this._executeQuery(e,{},t);return await this._reschedule((()=>this._filterLatest(i)),t),i.createQueryResponse()}catch(s){if(s!==_utils_js__WEBPACK_IMPORTED_MODULE_18__.vF)throw s;return new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y([],e,this).createQueryResponse()}}async executeQueryForSummaryStatistics(e={},t,i){const{field:s,normalizationField:r,valueExpression:a}=t;return(await this._getQueryEngineResultForStats(e,{field:s,normalizationField:r,valueExpression:a},i)).createSummaryStatisticsResponse(t)}async executeQueryForUniqueValues(e={},t,i){const{field:s,field2:r,field3:a,valueExpression:n}=t;return(await this._getQueryEngineResultForStats(e,{field:s,field2:r,field3:a,valueExpression:n},i)).createUniqueValuesResponse(t)}async executeQueryForClassBreaks(e={},t,i){const{field:s,normalizationField:r,valueExpression:a}=t;return(await this._getQueryEngineResultForStats(e,{field:s,normalizationField:r,valueExpression:a},i)).createClassBreaksResponse(t)}async executeQueryForHistogram(e={},t,i){const{field:s,normalizationField:r,valueExpression:a}=t;return(await this._getQueryEngineResultForStats(e,{field:s,normalizationField:r,valueExpression:a},i)).createHistogramResponse(t)}async fetchRecomputedExtents(e){const[t,i]=await Promise.all(["getFullExtent"in this.featureStore&&this.featureStore.getFullExtent?Promise.resolve(this.featureStore.getFullExtent(this.spatialReference)):this._getBounds(await this._getAllFeatures(),this.spatialReference,this.spatialReference),(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.pC)(this._timeExtentPromise)?this._timeExtentPromise:this._timeExtentPromise=(0,_timeSupport_js__WEBPACK_IMPORTED_MODULE_23__.R)(this.timeInfo,this.featureStore)]);return(0,_core_promiseUtils_js__WEBPACK_IMPORTED_MODULE_4__.k_)(e),{fullExtent:t,timeExtent:i}}async _getBounds(e,t,i){const s=(0,_geometry_support_aaBoundingBox_js__WEBPACK_IMPORTED_MODULE_6__.t8)((0,_geometry_support_aaBoundingBox_js__WEBPACK_IMPORTED_MODULE_6__.Ue)(),_geometry_support_aaBoundingBox_js__WEBPACK_IMPORTED_MODULE_6__.Gv);await this.featureStore.forEachBounds(e,(e=>(0,_geometry_support_aaBoundingBox_js__WEBPACK_IMPORTED_MODULE_6__.TC)(s,e)));const r={xmin:s[0],ymin:s[1],xmax:s[3],ymax:s[4],spatialReference:(0,_utils_js__WEBPACK_IMPORTED_MODULE_18__.S2)(this.spatialReference)};this.hasZ&&isFinite(s[2])&&isFinite(s[5])&&(r.zmin=s[2],r.zmax=s[5]);const a=(0,_projectionSupport_js__WEBPACK_IMPORTED_MODULE_14__.iV)(r,t,i);if(a.spatialReference=(0,_utils_js__WEBPACK_IMPORTED_MODULE_18__.S2)(i),a.xmax-a.xmin==0){const e=(0,_core_unitUtils_js__WEBPACK_IMPORTED_MODULE_5__.c9)(a.spatialReference);a.xmin-=e,a.xmax+=e}if(a.ymax-a.ymin==0){const e=(0,_core_unitUtils_js__WEBPACK_IMPORTED_MODULE_5__.c9)(a.spatialReference);a.ymin-=e,a.ymax+=e}if(this.hasZ&&null!=a.zmin&&null!=a.zmax&&a.zmax-a.zmin==0){const e=(0,_core_unitUtils_js__WEBPACK_IMPORTED_MODULE_5__.c9)(a.spatialReference);a.zmin-=e,a.zmax+=e}return a}async _schedule(e,t){return(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.pC)(this._frameTask)?this._frameTask.schedule(e,t):e(_views_support_Scheduler_js__WEBPACK_IMPORTED_MODULE_21__.G5)}async _reschedule(e,t){return(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.pC)(this._frameTask)?this._frameTask.reschedule(e,t):e(_views_support_Scheduler_js__WEBPACK_IMPORTED_MODULE_21__.G5)}async _getAllFeaturesQueryEngineResult(e){return new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y(await this._getAllFeatures(),e,this)}async _getAllFeatures(){if((0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.Wi)(this._allFeaturesPromise)){const e=[];this._allFeaturesPromise=(async()=>{await this.featureStore.forEach((t=>e.push(t)))})().then((()=>e))}const e=this._allFeaturesPromise,t=await e;return e===this._allFeaturesPromise?t.slice():this._getAllFeatures()}async _executeQuery(e,t,i){e=(0,_core_lang_js__WEBPACK_IMPORTED_MODULE_2__.d9)(e),e=await this._schedule((()=>(0,_utils_js__WEBPACK_IMPORTED_MODULE_18__.Up)(e,this.definitionExpression,this.spatialReference)),i),e=await this._reschedule((()=>this._checkQuerySupport(e)),i),e={...e,...t};const r=await this._reschedule((()=>this._executeSceneFilterQuery(e,i)),i),a=await this._reschedule((()=>this._executeGeometryQuery(e,r,i)),i);return await this._reschedule((()=>this._executeAggregateIdsQuery(a)),i),await this._reschedule((()=>this._executeObjectIdsQuery(a)),i),await this._reschedule((()=>this._executeTimeQuery(a)),i),await this._reschedule((()=>this._executeAttributesQuery(a)),i),a}async _executeSceneFilterQuery(e,t){if((0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.Wi)(e.sceneFilter))return null;const{outSR:i,returnGeometry:s,returnCentroid:r}=e,a=this.featureStore.featureSpatialReference,o=e.sceneFilter.geometry,u=(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.Wi)(a)||(0,_geometry_support_spatialReferenceUtils_js__WEBPACK_IMPORTED_MODULE_11__.fS)(a,o.spatialReference)?o:(0,_projectionSupport_js__WEBPACK_IMPORTED_MODULE_14__.iV)(o,a);if(!u)return null;const c=s||r,l=(0,_geometry_support_spatialReferenceUtils_js__WEBPACK_IMPORTED_MODULE_11__.JY)(i)&&!(0,_geometry_support_spatialReferenceUtils_js__WEBPACK_IMPORTED_MODULE_11__.fS)(this.spatialReference,i)&&c?async e=>this._project(e,i):e=>e,h=this.featureAdapter,m=await this._reschedule((()=>this._searchFeatures(this._getQueryBBoxes(u))),t);if("disjoint"===e.sceneFilter.spatialRelationship){if(!m.length)return null;const i=new Set;for(const e of m)i.add(h.getObjectId(e));const s=await this._reschedule((()=>this._getAllFeatures()),t);return l(await this._reschedule((async()=>{const r=await(0,_spatialQuerySupport_js__WEBPACK_IMPORTED_MODULE_17__.cW)("esriSpatialRelDisjoint",u,this.geometryType,this.hasZ,this.hasM),n=await this._runSpatialFilter(s,(e=>!i.has(h.getObjectId(e))||r(h.getGeometry(e))),t);return new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y(n,e,this)}),t))}if(!m.length)return new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y([],e,this);if(this._canExecuteSinglePass(u,e))return l(new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y(m,e,this));const p=await(0,_spatialQuerySupport_js__WEBPACK_IMPORTED_MODULE_17__.cW)("esriSpatialRelContains",u,this.geometryType,this.hasZ,this.hasM),f=await this._runSpatialFilter(m,(e=>p(h.getGeometry(e))),t);return l(new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y(f,e,this))}async _executeGeometryQuery(i,s,r){if((0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.pC)(s)&&0===s.items.length)return s;i=(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.pC)(s)?s.query:i;const{geometry:a,outSR:u,spatialRel:c,returnGeometry:l,returnCentroid:h}=i,m=this.featureStore.featureSpatialReference,p=!a||(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.Wi)(m)||(0,_geometry_support_spatialReferenceUtils_js__WEBPACK_IMPORTED_MODULE_11__.fS)(m,a.spatialReference)?a:(0,_projectionSupport_js__WEBPACK_IMPORTED_MODULE_14__.iV)(a,m),f=l||h,d=(0,_geometry_support_spatialReferenceUtils_js__WEBPACK_IMPORTED_MODULE_11__.JY)(u)&&!(0,_geometry_support_spatialReferenceUtils_js__WEBPACK_IMPORTED_MODULE_11__.fS)(this.spatialReference,u),y=this._geometryQueryCache&&(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.Wi)(s)?d&&f?JSON.stringify({originalFilterGeometry:a,spatialRelationship:c,outSpatialReference:u}):JSON.stringify({originalFilterGeometry:a,spatialRelationship:c}):null,g=y?this._geometryQueryCache.get(y):null;if((0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.pC)(g))return new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y(g,i,this);const _=async e=>(d&&f&&await this._project(e,u),y&&this._geometryQueryCache.put(y,e.items,e.items.length+1),e);if(!p)return _((0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.pC)(s)?s:await this._getAllFeaturesQueryEngineResult(i));const x=this.featureAdapter;let w=await this._reschedule((()=>this._searchFeatures(this._getQueryBBoxes(a))),r);if("esriSpatialRelDisjoint"===c){if(!w.length)return _((0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.pC)(s)?s:await this._getAllFeaturesQueryEngineResult(i));const e=new Set;for(const i of w)e.add(x.getObjectId(i));const t=(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.pC)(s)?s.items:await this._reschedule((()=>this._getAllFeatures()),r),a=await this._reschedule((async()=>{const s=await(0,_spatialQuerySupport_js__WEBPACK_IMPORTED_MODULE_17__.cW)(c,p,this.geometryType,this.hasZ,this.hasM),n=await this._runSpatialFilter(t,(t=>!e.has(x.getObjectId(t))||s(x.getGeometry(t))),r);return new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y(n,i,this)}),r);return _(a)}if((0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.pC)(s)){const i=new _core_arrayUtils_js__WEBPACK_IMPORTED_MODULE_0__.SO;w=w.filter((e=>(0,_core_arrayUtils_js__WEBPACK_IMPORTED_MODULE_0__.cq)(s.items,e,s.items.length,i)>=0))}if(!w.length){const e=new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y([],i,this);return y&&this._geometryQueryCache.put(y,e.items,1),e}if(this._canExecuteSinglePass(p,i))return _(new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y(w,i,this));const S=await(0,_spatialQuerySupport_js__WEBPACK_IMPORTED_MODULE_17__.cW)(c,p,this.geometryType,this.hasZ,this.hasM),F=await this._runSpatialFilter(w,(e=>S(x.getGeometry(e))),r);return _(new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y(F,i,this))}_executeAggregateIdsQuery(e){if(0===e.items.length||!e.query.aggregateIds||!e.query.aggregateIds.length||(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.Wi)(this.aggregateAdapter))return;const t=new Set;for(const s of e.query.aggregateIds)this.aggregateAdapter.getFeatureObjectIds(s).forEach((e=>t.add(e)));const i=this.featureAdapter.getObjectId;e.items=e.items.filter((e=>t.has(i(e))))}_executeObjectIdsQuery(e){if(0===e.items.length||!e.query.objectIds||!e.query.objectIds.length)return;const t=new Set(e.query.objectIds),i=this.featureAdapter.getObjectId;e.items=e.items.filter((e=>t.has(i(e))))}_executeTimeQuery(e){if(0===e.items.length)return;const t=(0,_timeSupport_js__WEBPACK_IMPORTED_MODULE_23__.y)(this.timeInfo,e.query.timeExtent,this.featureAdapter);(0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.Wi)(t)||(e.items=e.items.filter(t))}_executeAttributesQuery(e){if(0===e.items.length)return;const t=(0,_attributeSupport_js__WEBPACK_IMPORTED_MODULE_13__.Jc)(e.query.where,this.fieldsIndex);if(t){if(!t.isStandardized)throw new TypeError("Where clause is not standardized");e.items=e.items.filter((e=>t.testFeature(e,this.featureAdapter)))}}async _runSpatialFilter(e,t,i){if(!t)return e;if((0,_core_maybe_js__WEBPACK_IMPORTED_MODULE_22__.Wi)(this._frameTask))return e.filter((e=>t(e)));let s=0;const r=new Array,a=async n=>{for(;s<e.length;){const o=e[s++];t(o)&&(r.push(o),n.madeProgress()),n.done&&await this._reschedule((e=>a(e)),i)}};return this._reschedule((e=>a(e)),i).then((()=>r))}_filterLatest(e){const{trackIdField:t,startTimeField:i,endTimeField:s}=this.timeInfo,r=s||i,a=new Map,n=this.featureAdapter.getAttribute;for(const o of e.items){const e=n(o,t),i=n(o,r),s=a.get(e);(!s||i>n(s,r))&&a.set(e,o)}e.items=Array.from(a.values())}_canExecuteSinglePass(e,t){const{spatialRel:i}=t;return(0,_spatialQuerySupport_js__WEBPACK_IMPORTED_MODULE_17__.hN)(e)&&("esriSpatialRelEnvelopeIntersects"===i||"esriGeometryPoint"===this.geometryType&&("esriSpatialRelIntersects"===i||"esriSpatialRelContains"===i||"esriSpatialRelWithin"===i))}async _project(e,t){if(!t||(0,_geometry_support_spatialReferenceUtils_js__WEBPACK_IMPORTED_MODULE_11__.fS)(this.spatialReference,t))return e;const i=this.featureAdapter,s=await(0,_projectionSupport_js__WEBPACK_IMPORTED_MODULE_14__.oj)(e.items.map((e=>(0,_utils_js__WEBPACK_IMPORTED_MODULE_18__.Op)(this.geometryType,this.hasZ,this.hasM,i.getGeometry(e)))),this.spatialReference,t);return e.items=s.map(((t,s)=>i.cloneWithGeometry(e.items[s],(0,_featureConversionUtils_js__WEBPACK_IMPORTED_MODULE_12__.GH)(t,this.hasZ,this.hasM)))),e}_getQueryBBoxes(e){if((0,_spatialQuerySupport_js__WEBPACK_IMPORTED_MODULE_17__.hN)(e)){if((0,_geometry_support_jsonUtils_js__WEBPACK_IMPORTED_MODULE_9__.YX)(e))return[(0,_geometry_support_aaBoundingRect_js__WEBPACK_IMPORTED_MODULE_7__.al)(e.xmin,e.ymin,e.xmax,e.ymax)];if((0,_geometry_support_jsonUtils_js__WEBPACK_IMPORTED_MODULE_9__.oU)(e))return e.rings.map((e=>(0,_geometry_support_aaBoundingRect_js__WEBPACK_IMPORTED_MODULE_7__.al)(Math.min(e[0][0],e[2][0]),Math.min(e[0][1],e[2][1]),Math.max(e[0][0],e[2][0]),Math.max(e[0][1],e[2][1]))))}return[(0,_geometry_support_boundsUtils_js__WEBPACK_IMPORTED_MODULE_8__.$P)((0,_geometry_support_aaBoundingRect_js__WEBPACK_IMPORTED_MODULE_7__.Ue)(),e)]}async _searchFeatures(e){const t=new Set;await Promise.all(e.map((e=>this.featureStore.forEachInBounds(e,(e=>t.add(e))))));const i=Array.from(t.values());return t.clear(),i}async _checkStatisticsSupport(e,t){if((e.distance??0)<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text||e.outStatistics||e.groupByFieldsForStatistics||e.having||e.orderByFields)throw new _core_Error_js__WEBPACK_IMPORTED_MODULE_1__.Z($,"Unsupported query options",{query:e});return this._checkAttributesQuerySupport(e),Promise.all([this._checkStatisticsParamsSupport(t),(0,_spatialQuerySupport_js__WEBPACK_IMPORTED_MODULE_17__.P0)(e,this.geometryType,this.spatialReference),(0,_projectionSupport_js__WEBPACK_IMPORTED_MODULE_14__._W)(this.spatialReference,e.outSR)]).then((()=>e))}async _checkStatisticsParamsSupport(e){let t=[];if(e.valueExpression){const{arcadeUtils:i}=await(0,_support_arcadeOnDemand_js__WEBPACK_IMPORTED_MODULE_20__.LC)();t=i.extractFieldNames(e.valueExpression)}if(e.field&&t.push(e.field),e.field2&&t.push(e.field2),e.field3&&t.push(e.field3),e.normalizationField&&t.push(e.normalizationField),!t.length)throw new _core_Error_js__WEBPACK_IMPORTED_MODULE_1__.Z($,"params should have at least a field or valueExpression",{params:e});(0,_attributeSupport_js__WEBPACK_IMPORTED_MODULE_13__.Of)(this.fieldsIndex,t,"params contains missing fields")}async _checkQuerySupport(e){if((e.distance??0)<0||null!=e.geometryPrecision||e.multipatchOption||e.pixelSize||e.relationParam||e.text)throw new _core_Error_js__WEBPACK_IMPORTED_MODULE_1__.Z($,"Unsupported query options",{query:e});return this._checkAttributesQuerySupport(e),this._checkStatisticsQuerySupport(e),Promise.all([(0,_spatialQuerySupport_js__WEBPACK_IMPORTED_MODULE_17__.P0)(e,this.geometryType,this.spatialReference),(0,_projectionSupport_js__WEBPACK_IMPORTED_MODULE_14__._W)(this.spatialReference,e.outSR)]).then((()=>e))}_checkAttributesQuerySupport(e){const{outFields:t,orderByFields:s,returnDistinctValues:r,outStatistics:a}=e,n=a?a.map((e=>e.outStatisticFieldName&&e.outStatisticFieldName.toLowerCase())).filter(Boolean):[];if(s&&s.length>0){const e=" asc",t=" desc",i=s.map((i=>{const s=i.toLowerCase();return s.includes(e)?s.split(e)[0]:s.includes(t)?s.split(t)[0]:i})).filter((e=>!n.includes(e)));(0,_attributeSupport_js__WEBPACK_IMPORTED_MODULE_13__.Of)(this.fieldsIndex,i,"orderByFields contains missing fields")}if(t&&t.length>0)(0,_attributeSupport_js__WEBPACK_IMPORTED_MODULE_13__.Of)(this.fieldsIndex,t,"outFields contains missing fields");else if(r)throw new _core_Error_js__WEBPACK_IMPORTED_MODULE_1__.Z($,"outFields should be specified for returnDistinctValues",{query:e});(0,_attributeSupport_js__WEBPACK_IMPORTED_MODULE_13__.hO)(this.fieldsIndex,e.where)}_checkStatisticsQuerySupport(e){const{outStatistics:t,groupByFieldsForStatistics:s,having:r}=e,a=s&&s.length,n=t&&t.length;if(r){if(!a||!n)throw new _core_Error_js__WEBPACK_IMPORTED_MODULE_1__.Z($,"outStatistics and groupByFieldsForStatistics should be specified with having",{query:e});(0,_attributeSupport_js__WEBPACK_IMPORTED_MODULE_13__.z4)(this.fieldsIndex,r,t)}if(n){if(!function W(e){return null!=e&&e.every((e=>"exceedslimit"!==e.statisticType))}(t))return;const r=t.map((e=>e.onStatisticField)).filter(Boolean);(0,_attributeSupport_js__WEBPACK_IMPORTED_MODULE_13__.Of)(this.fieldsIndex,r,"onStatisticFields contains missing fields"),a&&(0,_attributeSupport_js__WEBPACK_IMPORTED_MODULE_13__.Of)(this.fieldsIndex,s,"groupByFieldsForStatistics contains missing fields");for(const s of t){const{onStatisticField:t,statisticType:r}=s;if("percentile_disc"!==r&&"percentile_cont"!==r||!("statisticParameters"in s)){if("count"!==r&&t&&(0,_attributeSupport_js__WEBPACK_IMPORTED_MODULE_13__.G3)(t,this.fieldsIndex))throw new _core_Error_js__WEBPACK_IMPORTED_MODULE_1__.Z($,"outStatistics contains non-numeric fields",{definition:s,query:e})}else{const{statisticParameters:t}=s;if(!t)throw new _core_Error_js__WEBPACK_IMPORTED_MODULE_1__.Z($,"statisticParamters should be set for percentile type",{definition:s,query:e})}}}}async _getQueryEngineResultForStats(e,t,i){e=(0,_core_lang_js__WEBPACK_IMPORTED_MODULE_2__.d9)(e);try{e=await this._schedule((()=>(0,_utils_js__WEBPACK_IMPORTED_MODULE_18__.Up)(e,this.definitionExpression,this.spatialReference)),i),e=await this._reschedule((()=>this._checkStatisticsSupport(e,t)),i);const s=await this._reschedule((()=>this._executeSceneFilterQuery(e,i)),i),r=await this._reschedule((()=>this._executeGeometryQuery(e,s,i)),i);return await this._reschedule((()=>this._executeAggregateIdsQuery(r)),i),await this._reschedule((()=>this._executeObjectIdsQuery(r)),i),await this._reschedule((()=>this._executeTimeQuery(r)),i),await this._reschedule((()=>this._executeAttributesQuery(r)),i),r}catch(r){if(r!==_utils_js__WEBPACK_IMPORTED_MODULE_18__.vF)throw r;return new _QueryEngineResult_js__WEBPACK_IMPORTED_MODULE_16__.y([],e,this)}}}},"./node_modules/@arcgis/core/layers/graphics/data/spatialQuerySupport.js":(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{hN:()=>I,P0:()=>P,cW:()=>v});var Error=__webpack_require__("./node_modules/@arcgis/core/core/Error.js"),contains=__webpack_require__("./node_modules/@arcgis/core/geometry/support/contains.js"),intersectsBase=__webpack_require__("./node_modules/@arcgis/core/geometry/support/intersectsBase.js");var jsonUtils=__webpack_require__("./node_modules/@arcgis/core/geometry/support/jsonUtils.js"),spatialReferenceUtils=__webpack_require__("./node_modules/@arcgis/core/geometry/support/spatialReferenceUtils.js");function n(n,t){return n?t?4:3:t?3:2}function contains_r(t,r,e,c,u,f){const s=n(u,f),{coords:i,lengths:l}=c;if(!l)return!1;for(let n=0,d=0;n<l.length;n++,d+=s)if(!o(t,r,e,i[d],i[d+1]))return!1;return!0}function o(t,r,o,c,u){if(!t)return!1;const f=n(r,o),{coords:s,lengths:i}=t;let l=!1,d=0;for(const n of i)l=e(l,s,f,d,n,c,u),d+=n*f;return l}function e(n,t,r,o,e,c,u){let f=n,s=o;for(let i=o,l=o+e*r;i<l;i+=r){s=i+r,s===l&&(s=o);const n=t[i],e=t[i+1],d=t[s],g=t[s+1];(e<u&&g>=u||g<u&&e>=u)&&n+(u-e)/(g-e)*(d-n)<c&&(f=!f)}return f}var featureConversionUtils=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/featureConversionUtils.js"),OptimizedGeometry=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/OptimizedGeometry.js"),projectionSupport=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/data/projectionSupport.js"),utils=__webpack_require__("./node_modules/@arcgis/core/layers/graphics/data/utils.js");const c="feature-store:unsupported-query",R={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},S={spatialRelationship:{esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},queryGeometry:{esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},layerGeometry:{esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1}};function v(e,n,l,y,c){if((0,jsonUtils.oU)(n)&&"esriGeometryPoint"===l&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=(0,featureConversionUtils.Uy)(new OptimizedGeometry.Z,n,!1,!1);return Promise.resolve((r=>function t(n,t,r,e){return o(n,t,r,e.coords[0],e.coords[1])}(e,!1,!1,r)))}if((0,jsonUtils.oU)(n)&&"esriGeometryMultipoint"===l){const r=(0,featureConversionUtils.Uy)(new OptimizedGeometry.Z,n,!1,!1);if("esriSpatialRelContains"===e)return Promise.resolve((e=>contains_r(r,!1,!1,e,y,c)))}if((0,jsonUtils.YX)(n)&&"esriGeometryPoint"===l&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return Promise.resolve((e=>(0,contains.aV)(n,(0,utils.Op)(l,y,c,e))));if((0,jsonUtils.YX)(n)&&"esriGeometryMultipoint"===l&&"esriSpatialRelContains"===e)return Promise.resolve((e=>(0,contains.lQ)(n,(0,utils.Op)(l,y,c,e))));if((0,jsonUtils.YX)(n)&&"esriSpatialRelIntersects"===e){const e=function s(s){return"mesh"===s?intersectsBase.h_:(0,intersectsBase.IY)(s)}(l);return Promise.resolve((r=>e(n,(0,utils.Op)(l,y,c,r))))}return function h(){return Promise.all([__webpack_require__.e(9067),__webpack_require__.e(3296)]).then(__webpack_require__.bind(__webpack_require__,"./node_modules/@arcgis/core/geometry/geometryEngineJSON.js"))}().then((r=>{const t=r[R[e]].bind(null,n.spatialReference,n);return e=>t((0,utils.Op)(l,y,c,e))}))}async function P(r,t,i){const{spatialRel:s,geometry:o}=r;if(o){if(!function G(e){return null!=e&&!0===S.spatialRelationship[e]}(s))throw new Error.Z(c,"Unsupported query spatial relationship",{query:r});if((0,spatialReferenceUtils.JY)(o.spatialReference)&&(0,spatialReferenceUtils.JY)(i)){if(!function g(e){return null!=e&&!0===S.queryGeometry[(0,jsonUtils.Ji)(e)]}(o))throw new Error.Z(c,"Unsupported query geometry type",{query:r});if(!function j(e){return null!=e&&!0===S.layerGeometry[e]}(t))throw new Error.Z(c,"Unsupported layer geometry type",{query:r});if(r.outSR)return(0,projectionSupport._W)(r.geometry&&r.geometry.spatialReference,r.outSR)}}}function I(e){if((0,jsonUtils.YX)(e))return!0;if((0,jsonUtils.oU)(e)){for(const r of e.rings){if(5!==r.length)return!1;if(r[0][0]!==r[1][0]||r[0][0]!==r[4][0]||r[2][0]!==r[3][0]||r[0][1]!==r[3][1]||r[0][1]!==r[4][1]||r[1][1]!==r[2][1])return!1}return!0}return!1}},"./node_modules/@arcgis/core/layers/graphics/data/timeSupport.js":(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__)=>{async function t(t,n){if(!t)return null;const e=n.featureAdapter,{startTimeField:u,endTimeField:l}=t;let r=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;if(u&&l)await n.forEach((t=>{const n=e.getAttribute(t,u),a=e.getAttribute(t,l);null==n||isNaN(n)||(r=Math.min(r,n)),null==a||isNaN(a)||(i=Math.max(i,a))}));else{const t=u||l;await n.forEach((n=>{const u=e.getAttribute(n,t);null==u||isNaN(u)||(r=Math.min(r,u),i=Math.max(i,u))}))}return{start:r,end:i}}function n(t,n,r){if(!n||!t)return null;const{startTimeField:i,endTimeField:a}=t;if(!i&&!a)return null;const{start:o,end:s}=n;return null===o&&null===s?null:void 0===o&&void 0===s?()=>!1:i&&a?function e(t,n,e,u,l){return null!=u&&null!=l?r=>{const i=t.getAttribute(r,n),a=t.getAttribute(r,e);return(null==i||i<=l)&&(null==a||a>=u)}:null!=u?n=>{const l=t.getAttribute(n,e);return null==l||l>=u}:null!=l?e=>{const u=t.getAttribute(e,n);return null==u||u<=l}:void 0}(r,i,a,o,s):function u(t,n,e,u){return null!=e&&null!=u&&e===u?u=>t.getAttribute(u,n)===e:null!=e&&null!=u?l=>{const r=t.getAttribute(l,n);return r>=e&&r<=u}:null!=e?u=>t.getAttribute(u,n)>=e:null!=u?e=>t.getAttribute(e,n)<=u:void 0}(r,i||a,o,s)}__webpack_require__.d(__webpack_exports__,{R:()=>t,y:()=>n})}}]);